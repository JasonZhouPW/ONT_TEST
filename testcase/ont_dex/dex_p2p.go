package ont_dex

import (
	. "github.com/ONT_TEST/testframework"
	"github.com/Ontology/account"
	"github.com/Ontology/core/contract"
	"github.com/Ontology/smartcontract/types"
	"time"
	"github.com/Ontology/common"
	"fmt"
	//"github.com/Ontology/crypto"
	//"math/rand"
)


func init(){
	fmt.Printf("-------> DexP2P CodeHash:%x Reverse:%x\n", DexP2P.CodeHash().ToArray(), DexP2P.CodeHash().ToArrayReverse())
}

var DexP2PCode = "0123c56b6c766b00527ac46c766b51527ac46151c56c766b52527ac46c766b52c30000c46168164e656f2e52756e74696d652e47657454726967676572009c6c766b53527ac46c766b53c3641d00616c766b52c30002b80bc46c766b52c36c766b54527ac4628a046168164e656f2e52756e74696d652e47657454726967676572609c6c766b55527ac46c766b55c3644704616c766b00c304696e6974876c766b56527ac46c766b56c364120061616549046c766b54527ac46236046c766b00c30c6d616b656275796f72646572876c766b57527ac46c766b57c364d500616c766b51c3c0569c009c6c766b5e527ac46c766b5ec3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac462e0036c766b51c300c36c766b58527ac46c766b51c351c36c766b59527ac46c766b51c352c36c766b5a527ac46c766b51c353c36c766b5b527ac46c766b51c354c36c766b5c527ac46c766b51c355c36c766b5d527ac46c766b58c36c766b59c36c766b5ac36c766b5bc36c766b5cc36c766b5dc36155795179577275517275547952795672755272755379537955727553727565a0046c766b54527ac46242036c766b00c3106275796f72646572636f6d706c657465876c766b5f527ac46c766b5fc3647000616c766b51c3c0529c009c6c766b0112527ac46c766b0112c3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac462e6026c766b51c300c36c766b60527ac46c766b51c351c36c766b0111527ac46c766b60c36c766b0111c3617c655a076c766b54527ac462af026c766b00c30e6275796f7264657263616e63656c876c766b0113527ac46c766b0113c3647200616c766b51c3c0529c009c6c766b0116527ac46c766b0116c3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac46253026c766b51c300c36c766b0114527ac46c766b51c351c36c766b0115527ac46c766b0114c36c766b0115c3617c65280a6c766b54527ac4621a026c766b00c31373656c6c6572747279636c6f73656f72646572876c766b0117527ac46c766b0117c3647200616c766b51c3c0529c009c6c766b011a527ac46c766b011ac3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac462b9016c766b51c300c36c766b0118527ac46c766b51c351c36c766b0119527ac46c766b0118c36c766b0119c3617c65ef0c6c766b54527ac46280016c766b00c30b6368616e676561646d696e876c766b011b527ac46c766b011bc3645c00616c766b51c3c0519c009c6c766b011d527ac46c766b011dc3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac46227016c766b51c300c36c766b011c527ac46c766b011cc3616579106c766b54527ac46204016c766b00c30867657461646d696e876c766b011e527ac46c766b011ec364120061616572116c766b54527ac462d5006c766b00c3107365746f726465726c6f636b74696d65876c766b011f527ac46c766b011fc3645c00616c766b51c3c0519c009c6c766b0121527ac46c766b0121c3641d00616c766b52c30002b90bc46c766b52c36c766b54527ac46277006c766b51c300c36c766b0120527ac46c766b0120c361655a116c766b54527ac46254006c766b00c3106765746f726465726c6f636b74696d65876c766b0122527ac46c766b0122c364120061616580126c766b54527ac4621d00616c766b52c30002ba0bc46c766b52c36c766b54527ac46203006c766b54c3616c756654c56b6151c56c766b00527ac46c766b00c30000c46168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e617c680f4e656f2e53746f726167652e4765746c766b51527ac46c766b51c3c000a06c766b52527ac46c766b52c3641d00616c766b00c30002c10bc46c766b00c36c766b53527ac462c30061682b53797374656d2e457865637574696f6e456e67696e652e47657443616c6c696e67536372697074486173686c766b51527ac46168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e6c766b51c3615272680f4e656f2e53746f726167652e507574616168164e656f2e53746f726167652e476574436f6e746578740d6f726465726c6f636b74696d6503002f0d615272680f4e656f2e53746f726167652e507574616c766b00c36c766b53527ac46203006c766b53c3616c75660115c56b6c766b00527ac46c766b51527ac46c766b52527ac46c766b53527ac46c766b54527ac46c766b55527ac46151c56c766b56527ac46c766b56c30000c46c766b53c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b0111527ac46c766b0111c3641e00616c766b56c30002c00bc46c766b56c36c766b0112527ac462b8026168184e656f2e426c6f636b636861696e2e4765744865696768746168184e656f2e426c6f636b636861696e2e4765744865616465726c766b57527ac46c766b57c36168174e656f2e4865616465722e47657454696d657374616d706c766b58527ac4066f62757965726c766b51c3617c6574106c766b59527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b59c3617c680f4e656f2e53746f726167652e4765746c766b5a527ac46c766b5ac3c000a06c766b0113527ac46c766b0113c3641e00616c766b56c30002bc0bc46c766b56c36c766b0112527ac462d101076f616d6f756e746c766b51c3617c65ef0f6c766b5b527ac4076f73656c6c65726c766b51c3617c65d60f6c766b5c527ac4056f74696d656c766b51c3617c65bf0f6c766b5d527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b5bc36c766b55c3615272680f4e656f2e53746f726167652e507574616168164e656f2e53746f726167652e476574436f6e746578746c766b59c36c766b52c3615272680f4e656f2e53746f726167652e507574616168164e656f2e53746f726167652e476574436f6e746578746c766b5cc36c766b53c3615272680f4e656f2e53746f726167652e507574616168164e656f2e53746f726167652e476574436f6e746578746c766b5dc36c766b58c3615272680f4e656f2e53746f726167652e5075746153c576006c766b52c3c476516c766b53c3c476526c766b55c3c46c766b5e527ac40b6f6e6d616b656f726465726c766b5ec3617c6790bebbfc8ec3f7f06b74752e921a923129bdcc816c766b5f527ac46c766b5fc300c36c766b60527ac46c766b60c3009c009c6c766b0114527ac46c766b0114c3642000616c766b56c3006c766b60c3c46c766b5fc36c766b0112527ac46213006c766b56c36c766b0112527ac46203006c766b0112c3616c75660112c56b6c766b00527ac46c766b51527ac46151c56c766b52527ac46c766b52c30000c46c766b51c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5d527ac46c766b5dc3641d00616c766b52c30002c00bc46c766b52c36c766b5e527ac462ee02066f62757965726c766b00c3617c65a90d6c766b53527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c680f4e656f2e53746f726167652e4765746c766b54527ac46c766b54c3c0009c6c766b5f527ac46c766b5fc3641d00616c766b52c30002bd0bc46c766b52c36c766b5e527ac4626d026c766b54c36c766b51c39c009c6c766b60527ac46c766b60c3641d00616c766b52c30002bf0bc46c766b52c36c766b5e527ac4623702076f616d6f756e746c766b00c3617c65f10c6c766b55527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c680f4e656f2e53746f726167652e4765746c766b56527ac4076f73656c6c65726c766b00c3617c65a00c6c766b57527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c680f4e656f2e53746f726167652e4765746c766b58527ac453c576006c766b54c3c476516c766b58c3c476526c766b56c3c46c766b59527ac40f6f6e6f72646572636f6d706c6574656c766b59c3617c6790bebbfc8ec3f7f06b74752e921a923129bdcc816c766b5a527ac46c766b5ac300c36c766b5b527ac46c766b5bc3009c009c6c766b0111527ac46c766b0111c3641f00616c766b52c3006c766b5bc3c46c766b52c36c766b5e527ac462fd00056f74696d656c766b00c3617c65b90b6c766b5c527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b5cc3617c68124e656f2e53746f726167652e44656c657465616c766b52c36c766b5e527ac46203006c766b5ec3616c75660112c56b6c766b00527ac46c766b51527ac46151c56c766b52527ac46c766b52c30000c46c766b51c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5d527ac46c766b5dc3641d00616c766b52c30002c00bc46c766b52c36c766b5e527ac462ec02066f62757965726c766b00c3617c65460a6c766b53527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c680f4e656f2e53746f726167652e4765746c766b54527ac46c766b54c3c0009c6c766b5f527ac46c766b5fc3641d00616c766b52c30002bd0bc46c766b52c36c766b5e527ac4626b026c766b54c36c766b51c39c009c6c766b60527ac46c766b60c3641d00616c766b52c30002bf0bc46c766b52c36c766b5e527ac4623502076f616d6f756e746c766b00c3617c658e096c766b55527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c680f4e656f2e53746f726167652e4765746c766b56527ac4076f73656c6c65726c766b00c3617c653d096c766b57527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c680f4e656f2e53746f726167652e4765746c766b58527ac453c576006c766b54c3c476516c766b58c3c476526c766b56c3c46c766b59527ac40d6f6e6f7264657263616e63656c6c766b59c3617c6790bebbfc8ec3f7f06b74752e921a923129bdcc816c766b5a527ac46c766b5ac300c36c766b5b527ac46c766b5bc3009c009c6c766b0111527ac46c766b0111c3641f00616c766b52c3006c766b5bc3c46c766b52c36c766b5e527ac462fd00056f74696d656c766b00c3617c6558086c766b5c527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b5cc3617c68124e656f2e53746f726167652e44656c657465616c766b52c36c766b5e527ac46203006c766b5ec3616c75660116c56b6c766b00527ac46c766b51527ac46151c56c766b52527ac46c766b52c30000c4066f62757965726c766b00c3617c6530076c766b53527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c680f4e656f2e53746f726167652e4765746c766b54527ac46c766b54c3c0009c6c766b0111527ac46c766b0111c3641e00616c766b52c30002bd0bc46c766b52c36c766b0112527ac4625703076f73656c6c65726c766b00c3617c65ab066c766b55527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c680f4e656f2e53746f726167652e4765746c766b56527ac46c766b56c36c766b51c39c009c6c766b0113527ac46c766b0113c3641e00616c766b52c30002bf0bc46c766b52c36c766b0112527ac462cd02056f74696d656c766b00c3617c6523066c766b57527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c680f4e656f2e53746f726167652e4765746c766b58527ac46168184e656f2e426c6f636b636861696e2e4765744865696768746168184e656f2e426c6f636b636861696e2e4765744865616465726c766b59527ac46c766b59c36168174e656f2e4865616465722e47657454696d657374616d706c766b5a527ac461650f0551c36c766b5b527ac46c766b5ac36c766b58c3946c766b5bc39f6c766b0114527ac46c766b0114c3641e00616c766b52c30002be0bc46c766b52c36c766b0112527ac462d101076f616d6f756e746c766b00c3617c6525056c766b5c527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b5cc3617c680f4e656f2e53746f726167652e4765746c766b5d527ac453c576006c766b54c3c476516c766b56c3c476526c766b5dc3c46c766b5e527ac40f6f6e6f72646572636f6d706c6574656c766b5ec3617c6790bebbfc8ec3f7f06b74752e921a923129bdcc816c766b5f527ac46c766b5fc300c36c766b60527ac46c766b60c3009c009c6c766b0115527ac46c766b0115c3642000616c766b52c3006c766b60c3c46c766b52c36c766b0112527ac462e7006168164e656f2e53746f726167652e476574436f6e746578746c766b53c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b55c3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b5cc3617c68124e656f2e53746f726167652e44656c657465616168164e656f2e53746f726167652e476574436f6e746578746c766b57c3617c68124e656f2e53746f726167652e44656c657465616c766b52c36c766b0112527ac46203006c766b0112c3616c756656c56b6c766b00527ac46151c56c766b51527ac46c766b51c30000c46168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e617c680f4e656f2e53746f726167652e4765746c766b52527ac46c766b52c3c0009c6c766b53527ac46c766b53c3641d00616c766b51c30002c20bc46c766b51c36c766b54527ac46299006c766b52c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b55527ac46c766b55c3641d00616c766b51c30002c00bc46c766b51c36c766b54527ac4624e006168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e6c766b00c3615272680f4e656f2e53746f726167652e507574616c766b51c36c766b54527ac46203006c766b54c3616c756652c56b6152c56c766b00527ac46c766b00c30000c46c766b00c3516168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e617c680f4e656f2e53746f726167652e476574c46c766b00c36c766b51527ac46203006c766b51c3616c756657c56b6c766b00527ac46151c56c766b51527ac46c766b51c30000c46c766b00c3009f6c766b53527ac46c766b53c3641d00616c766b51c30002b90bc46c766b51c36c766b54527ac4620b016168164e656f2e53746f726167652e476574436f6e746578740870327061646d696e617c680f4e656f2e53746f726167652e4765746c766b52527ac46c766b52c3c0009c6c766b55527ac46c766b55c3641d00616c766b51c30002c20bc46c766b51c36c766b54527ac4629e006c766b52c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b56527ac46c766b56c3641d00616c766b51c30002c00bc46c766b51c36c766b54527ac46253006168164e656f2e53746f726167652e476574436f6e746578740d6f726465726c6f636b74696d656c766b00c3615272680f4e656f2e53746f726167652e507574616c766b51c36c766b54527ac46203006c766b54c3616c756652c56b6152c56c766b00527ac46c766b00c30000c46c766b00c3516168164e656f2e53746f726167652e476574436f6e746578740d6f726465726c6f636b74696d65617c680f4e656f2e53746f726167652e476574c46c766b00c36c766b51527ac46203006c766b51c3616c756653c56b6c766b00527ac46c766b51527ac4616c766b00c36c766b51c37e6c766b52527ac46203006c766b52c3616c7566"
var DexP2P = NewDexP2PContract()

type DexP2PContract struct{}

func NewDexP2PContract() *DexP2PContract {
	return &DexP2PContract{}
}
func (this *DexP2PContract) CodeHash() *common.Uint160 {
	c, _ := common.HexToBytes(DexP2PCode)
	hashCode, _ := common.ToCodeHash(c)
	return &hashCode
}

func deployDexP2P(ctx *TestFrameworkContext) bool {
	code := DEXP2PCode
	_, err := ctx.Ont.DeploySmartContract(ctx.OntClient.Account1,
		code,
		[]contract.ContractParameterType{contract.String, contract.Array},
		contract.ContractParameterType(contract.Array),
		"TestDExP2P",
		"1.0",
		"",
		"",
		"",
		types.NEOVM,
	)
	if err != nil {
		ctx.LogError("deployDexP2P DeploySmartContract error:%s", err)
		return false
	}
	//等待出块
	_, err = ctx.Ont.WaitForGenerateBlock(30*time.Second, 1)
	if err != nil {
		ctx.LogError("deployDexP2P WaitForGenerateBlock error:%s", err)
		return false
	}
	//
	//if !testDexP2PInit(ctx){
	//	return false
	//}
	//buyer := ctx.OntClient.Account1
	//seller := ctx.OntClient.Account2
	//orderId := []byte(fmt.Sprint("%d", rand.Int31()))
	//orderSig, err := crypto.Sign(buyer.PrivateKey, orderId)
	//if err != nil {
	//	ctx.LogError("TestDexP2P crypto.Sign error:%s", err)
	//	return false
	//}
	//amount := 10
	//if !testReceipt(ctx, buyer, amount) {
	//	return false
	//}
	//if !testMakeBuyOrder(ctx, orderSig, orderId, buyer, seller, amount) {
	//	return false
	//}
	//
	//if !testBuyOrderComplete(ctx, orderId, buyer){
	//	return false
	//}
	//
	//orderId = []byte(fmt.Sprint("%d", rand.Int31()))
	//orderSig, err = crypto.Sign(buyer.PrivateKey, orderId)
	//if err != nil {
	//	ctx.LogError("TestDexP2P crypto.Sign error:%s", err)
	//	return false
	//}
	//amount = 11
	//if !testReceipt(ctx, buyer, amount) {
	//	return false
	//}
	//if !testMakeBuyOrder(ctx, orderSig, orderId, buyer, seller, amount) {
	//	return false
	//}
	//
	//if !testBuyOrderCancel(ctx, orderId, buyer){
	//	return false
	//}
	return true
}

func dexP2PInit(ctx *TestFrameworkContext)bool{
	res, err := ctx.Ont.InvokeSmartContract(
		ctx.OntClient.Account1,
		DEXP2PCode,
		[]interface{}{"init", []interface{}{}},
	)
	if err != nil {
		ctx.LogError("dexP2PInit error:%s", err)
		return false
	}
	if err != nil {
		ctx.LogError("dexP2PInit error:%s", err)
		return false
	}
	ctx.LogInfo("dexP2PInit res:%v", res)
	errorCode, err := GetErrorCode(res)
	if err != nil {
		ctx.LogError("dexP2PInit getErrorCode error:%s", err)
		return false
	}
	if errorCode != 0 && errorCode != 3009 {
		ctx.LogError("dexP2PInit failed errorCode:%d", errorCode)
		return false
	}
	return true
}

func makeBuyOrder(ctx *TestFrameworkContext, orderSig, orderId []byte, buyer, seller *account.Account, amount int) bool {
	buyerPk, err := buyer.PublicKey.EncodePoint(true)
	if err != nil {
		ctx.LogError("makeBuyOrder PublicKey.EncodePoint error:%s", err)
		return false
	}
	res, err := ctx.Ont.InvokeSmartContract(
		seller,
		DEXP2PCode,
		[]interface{}{"makebuyorder", []interface{}{orderSig, orderId, buyer.ProgramHash.ToArray(), seller.ProgramHash.ToArray(), buyerPk, amount}},
	)
	if err != nil {
		ctx.LogError("makeBuyOrder error:%s", err)
		return false
	}
	ctx.LogInfo("makeBuyOrder res:%v", res)
	errorCode, err := GetErrorCode(res)
	if err != nil {
		ctx.LogError("makeBuyOrder getErrorCode error:%s", err)
		return false
	}
	if errorCode != 0 {
		ctx.LogError("makeBuyOrder failed errorCode:%d", errorCode)
		return false
	}
	return true
}

func buyOrderComplete(ctx *TestFrameworkContext, orderId []byte, buyer *account.Account)bool{
	res, err := ctx.Ont.InvokeSmartContract(
		buyer,
		DEXP2PCode,
		[]interface{}{"buyordercomplete", []interface{}{orderId, buyer.ProgramHash.ToArray()}},
	)
	if err != nil {
		ctx.LogError("buyOrderComplete error:%s", err)
		return false
	}
	ctx.LogInfo("buyOrderComplete res:%v", res)
	errorCode, err := GetErrorCode(res)
	if err != nil {
		ctx.LogError("buyOrderComplete getErrorCode error:%s", err)
		return false
	}
	if errorCode != 0 {
		ctx.LogError("buyOrderComplete failed errorCode:%d", errorCode)
		return false
	}
	return true
}

func buyOrderCancel(ctx *TestFrameworkContext, orderId []byte, buyer *account.Account)bool{
	res, err := ctx.Ont.InvokeSmartContract(
		buyer,
		DEXP2PCode,
		[]interface{}{"buyordercancel", []interface{}{orderId, buyer.ProgramHash.ToArray()}},
	)
	if err != nil {
		ctx.LogError("buyOrderComplete error:%s", err)
		return false
	}
	ctx.LogInfo("buyOrderComplete res:%v", res)
	errorCode, err := GetErrorCode(res)
	if err != nil {
		ctx.LogError("buyOrderComplete getErrorCode error:%s", err)
		return false
	}
	if errorCode != 0 {
		ctx.LogError("buyOrderComplete failed errorCode:%d", errorCode)
		return false
	}
	return true
}

